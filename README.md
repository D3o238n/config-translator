# Транслятор учебного конфигурационного языка в YAML

Инструмент командной строки для преобразования текста из учебного конфигурационного языка в формат YAML с поддержкой вычисления константных выражений на этапе трансляции.

## Общее описание

Транслятор выполняет следующие функции:

- **Лексический анализ** - разбивает исходный текст на токены
- **Синтаксический анализ** - строит абстрактное синтаксическое дерево (AST)
- **Вычисление константных выражений** - выполняет вычисления в постфиксной форме
- **Генерация YAML** - преобразует вычисленные константы в формат YAML
- **Обработка ошибок** - выявляет и сообщает о синтаксических ошибках

### Синтаксис учебного конфигурационного языка

#### Комментарии

```
:: Однострочный комментарий

<# 
Многострочный
комментарий 
#>
```

#### Числа

Формат: `\d+\.\d*` (целая часть обязательна, дробная опциональна)

```
42.0
3.14159
10.
```

#### Массивы

Синтаксис: `[ значение; значение; значение ]`

```
numbers <- [ 1.0; 2.0; 3.0 ];
nested <- [ [ 1.0; 2.0 ]; [ 3.0; 4.0 ] ];
empty <- [];
```

#### Словари

Синтаксис: `{ имя = значение; имя = значение }`

```
person <- { name = 1.0; age = 25.0 };
config <- { 
    host = 127.0; 
    settings = { timeout = 30.0 } 
};
```

#### Имена

Формат: `[a-z][a-z0-9_]*` (начинается с строчной буквы)

```
variable
my_var_123
config_value
```

#### Объявление константы

Синтаксис: `имя <- значение;`

```
x <- 42.0;
arr <- [ 1.0; 2.0; 3.0 ];
cfg <- { key = 10.0 };
```

#### Константные выражения (постфиксная форма)

Синтаксис: `.(элементы выражения).`

```
:: Сложение
sum <- .(5.0 3.0 +).;  :: Результат: 8.0

:: Вычитание
diff <- .(10.0 7.0 -).;  :: Результат: 3.0

:: С использованием переменных
x <- 10.0;
result <- .(x 5.0 +).;  :: Результат: 15.0

:: Сортировка массива
nums <- [ 3.0; 1.0; 4.0; 1.0; 5.0 ];
sorted <- .(nums sort()).;  :: Результат: [1.0, 1.0, 3.0, 4.0, 5.0]

:: Конкатенация массивов
arr1 <- [ 1.0; 2.0 ];
arr2 <- [ 3.0; 4.0 ];
combined <- .(arr1 arr2 +).;  :: Результат: [1.0, 2.0, 3.0, 4.0]

:: Сложное выражение
a <- 10.0;
b <- 5.0;
c <- 3.0;
result <- .(a b + c -).;  :: (10 + 5) - 3 = 12.0
```

#### Поддерживаемые операции

1. **Сложение (`+`)**
   - Числа: `.(5.0 3.0 +).` → `8.0`
   - Массивы (конкатенация): `.(arr1 arr2 +).` → объединённый массив

2. **Вычитание (`-`)**
   - Только для чисел: `.(10.0 3.0 -).` → `7.0`

3. **Сортировка (`sort()`)**
   - Только для массивов: `.(array sort()).` → отсортированный массив

## Описание функций и настроек

### Модули проекта

#### `src/lexer.py` - Лексический анализатор

**Классы:**
- `TokenType` - перечисление типов токенов
- `Token` - представление токена (тип, значение, позиция)
- `Lexer` - лексический анализатор

**Основные методы:**
- `tokenize()` - выполняет лексический анализ текста, возвращает список токенов
- `skip_whitespace()` - пропускает пробельные символы
- `skip_single_line_comment()` - обрабатывает однострочные комментарии
- `skip_multi_line_comment()` - обрабатывает многострочные комментарии
- `read_number()` - распознаёт числа
- `read_name()` - распознаёт имена и ключевые слова

**Обрабатываемые ошибки:**
- Неожиданные символы
- Заглавные буквы в именах
- Незакрытые многострочные комментарии

#### `src/parser.py` - Синтаксический анализатор

**Классы AST узлов:**
- `NumberNode` - число
- `ArrayNode` - массив
- `DictNode` - словарь
- `NameNode` - ссылка на константу
- `ConstDeclarationNode` - объявление константы
- `ConstExpressionNode` - константное выражение
- `ProgramNode` - корневой узел программы

**Класс Parser:**
- `parse()` - парсит всю программу
- `parse_statement()` - парсит одну инструкцию
- `parse_value()` - парсит значение
- `parse_array()` - парсит массив
- `parse_dict()` - парсит словарь
- `parse_const_expression()` - парсит константное выражение

**Обрабатываемые ошибки:**
- Отсутствие ожидаемых токенов
- Незакрытые конструкции
- Неверный синтаксис словарей и массивов

#### `src/evaluator.py` - Вычислитель константных выражений

**Класс Evaluator:**
- `evaluate_program()` - вычисляет все константы в программе
- `evaluate_value()` - вычисляет значение узла AST
- `evaluate_postfix_expression()` - вычисляет постфиксное выражение

**Поддерживаемые операции:**
- Арифметические: `+`, `-`
- Функции: `sort()`
- Работа с переменными

**Обрабатываемые ошибки:**
- Неопределённые константы
- Несовместимые типы в операциях
- Недостаточно операндов
- Ошибки сортировки

#### `src/translator.py` - Транслятор в YAML

**Класс Translator:**
- `translate(input_text: str) -> str` - транслирует текст в YAML
- `translate_file(input_path: str, output_path: str)` - транслирует файл

**Возможности:**
- Полная обработка входного языка
- Генерация читаемого YAML
- Сохранение порядка объявлений
- Обработка Unicode

#### `src/cli.py` - Интерфейс командной строки

**Аргументы:**
- `-i, --input FILE` - путь к входному файлу (обязательный)
- `-o, --output FILE` - путь к выходному файлу (обязательный)
- `-v, --verbose` - подробный вывод
- `--version` - версия программы

## Команды для сборки и запуска

### Быстрый запуск

Для быстрого запуска используйте run_tests.bat или run_tests.sh (зависит от вашего ОС) 

### Установка зависимостей

```bash
# Создание виртуального окружения (рекомендуется)
python -m venv venv

# Активация виртуального окружения
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# Установка зависимостей
pip install -r requirements.txt

# Установка в режиме разработки
pip install -e .
```

### Запуск транслятора

```bash
# Базовое использование
python -m src.cli -i input.txt -o output.yaml

# С подробным выводом
python -m src.cli -i input.txt -o output.yaml -v

# После установки пакета
config-translator -i input.txt -o output.yaml
```

### Запуск тестов

```bash
# Запуск всех тестов
pytest

# Запуск с покрытием кода
pytest --cov=src --cov-report=html

# Запуск конкретного файла тестов
pytest tests/test_lexer.py

# Запуск с подробным выводом
pytest -v

# Запуск конкретного теста
pytest tests/test_lexer.py::TestLexerNumbers::test_integer
```

### Проверка кода

```bash
# Проверка стиля кода (если используется flake8)
flake8 src tests

# Форматирование кода (если используется black)
black src tests

# Проверка типов (если используется mypy)
mypy src
```

## Примеры использования

### Пример 1: Простая конфигурация

**Входной файл (simple.txt):**
```
:: Простая конфигурация
name <- 1.0;
version <- 2.5;
settings <- {
    timeout = 30.0;
    retries = 3.0
};
```

**Команда:**
```bash
python -m src.cli -i simple.txt -o simple.yaml
```

**Выходной файл (simple.yaml):**
```yaml
name: 1.0
version: 2.5
settings:
  timeout: 30.0
  retries: 3.0
```

### Пример 2: Использование константных выражений

**Входной файл (calc.txt):**
```
:: Вычисления
base <- 10.0;
increment <- 5.0;
total <- .(base increment +).;

numbers <- [ 3.0; 1.0; 4.0; 1.0; 5.0 ];
sorted_numbers <- .(numbers sort()).;
```

**Команда:**
```bash
python -m src.cli -i calc.txt -o calc.yaml
```

**Выходной файл (calc.yaml):**
```yaml
base: 10.0
increment: 5.0
total: 15.0
numbers:
- 3.0
- 1.0
- 4.0
- 1.0
- 5.0
sorted_numbers:
- 1.0
- 1.0
- 3.0
- 4.0
- 5.0
```

### Пример 3: Конфигурация базы данных

**Входной файл (database_config.txt):**
```
:: Конфигурация БД
host <- 127.0;
port <- 5432.0;
min_conn <- 10.0;
max_conn <- 100.0;

database <- {
    host = host;
    port = port;
    pool = {
        min = min_conn;
        max = max_conn;
        total = .(min_conn max_conn +).
    }
};
```

**Команда:**
```bash
python -m src.cli -i database_config.txt -o database_config.yaml -v
```

**Выходной файл (database_config.yaml):**
```yaml
host: 127.0
port: 5432.0
min_conn: 10.0
max_conn: 100.0
database:
  host: 127.0
  port: 5432.0
  pool:
    min: 10.0
    max: 100.0
    total: 110.0
```

### Пример 4: Сложная вложенная структура

**Входной файл (complex.txt):**
```
<# Комплексная конфигурация #>

:: Базовые значения
value1 <- 5.0;
value2 <- 3.0;
value3 <- 2.0;

:: Массивы
array1 <- [ 1.0; 2.0; 3.0 ];
array2 <- [ 4.0; 5.0; 6.0 ];
combined <- .(array1 array2 +).;

:: Вычисления
sum <- .(value1 value2 +).;
result <- .(sum value3 -).;

:: Итоговая структура
config <- {
    values = {
        base = [ value1; value2; value3 ];
        computed = [ sum; result ]
    };
    arrays = {
        first = array1;
        second = array2;
        merged = combined
    }
};
```

**Команда:**
```bash
python -m src.cli -i complex.txt -o complex.yaml
```

## Примеры из предметных областей

В директории `examples/` находятся три примера конфигураций:

1. **database_config.txt** - конфигурация базы данных
   - Настройки подключения и пулов
   - Конфигурация репликации
   - Параметры резервного копирования
   - Мониторинг и метрики

2. **web_server_config.txt** - конфигурация веб-сервера
   - HTTP/HTTPS настройки
   - Балансировка нагрузки
   - Кэширование и сжатие
   - Безопасность и логирование

3. **game_settings.txt** - настройки RPG игры
   - Характеристики классов персонажей
   - Уровни сложности
   - Система прокачки
   - Оружие, броня и враги

**Запуск примеров:**
```bash
python -m src.cli -i examples/database_config.txt -o output/database.yaml
python -m src.cli -i examples/web_server_config.txt -o output/webserver.yaml
python -m src.cli -i examples/game_settings.txt -o output/game.yaml
```

## Структура проекта

```
config-translator/
├── README.md                   # Документация
├── requirements.txt            # Зависимости Python
├── setup.py                    # Установочный скрипт
├── .gitignore                  # Игнорируемые файлы
│
├── src/                        # Исходный код
│   ├── __init__.py
│   ├── cli.py                  # Командная строка
│   ├── lexer.py                # Лексический анализатор
│   ├── parser.py               # Синтаксический анализатор
│   ├── evaluator.py            # Вычислитель выражений
│   └── translator.py           # Транслятор в YAML
│
├── tests/                      # Тесты
│   ├── __init__.py
│   ├── test_lexer.py           # Тесты лексера
│   ├── test_parser.py          # Тесты парсера
│   └── test_translator.py      # Интеграционные тесты
│
└── examples/                   # Примеры конфигураций
    ├── database_config.txt     # Пример 1: База данных
    ├── web_server_config.txt   # Пример 2: Веб-сервер
    └── game_settings.txt       # Пример 3: Игровые настройки
```

## Обработка ошибок

Транслятор выявляет и сообщает о следующих типах ошибок:

### Лексические ошибки
```
Ошибка на строке 5, колонке 10: Неожиданный символ: '@'
```

### Синтаксические ошибки
```
Синтаксическая ошибка на строке 3, колонке 15: Ожидался ';', получен '}'
```

### Ошибки вычисления
```
Ошибка вычисления: Неопределенная константа: undefined_var
Ошибка вычисления: Операция '-' требует числовые операнды
```

## Требования

- Python 3.8+
- PyYAML 6.0+
- pytest 7.0+ (для тестов)
- pytest-cov (для coverage)

## Лицензия

MIT License

## Автор

Выполнено в рамках учебного задания по созданию транслятора конфигурационного языка.
